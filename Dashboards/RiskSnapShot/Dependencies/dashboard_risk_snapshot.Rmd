---
title: "Risk Snapshot"
date: '`r paste0("Dashboard created at: ", Sys.time())`'
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    storyboard: false
    vertical_layout: fill
    logo: www/logo-icon.png
    self_contained: true
params: 
  workflow_object: null
---

```{r setup, include=FALSE}
library(flexdashboard)
library(knitr)
library(kableExtra)
library(ggplot2)
library(treemapify)
```
<script>
$('.navbar-logo').wrap('<a href="https://www.envisionrisk.com" target=_blank>');
</script>


<style>
.navbar, [data-toggle=tab], .navbar-brand  {   background-color:#AEC0C9;   border-color:black;   color:white; }

.navbar-logo img {
    position: absolute;
    right: 0px;
}

.navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    background-color: #27647B;
    color: white;
}
.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: white;
  background-color: #27647B;
}
.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  background-color: #27647B;
}
.navbar-inverse .navbar-collapse,
.navbar-inverse .navbar-form {
  border-color: #27647B;
}
</style>

Summary {data-navmenu="Navigate"}
=====================================  

Row {data-height=50}
-------------------------------------

This dashboard, designed with the following settings, comprises two sections: 'Summary' and 'Risk Decomposition.' The 'Summary' section, which you're currently viewing, provides the portfolio's profit/loss distribution within the given context. In contrast, the 'Risk Decomposition' section offers in-depth risk insights for the top 10 portfolio positions based on market value and risk, along with portfolio diversification details. Use the 'Navigate' dropdown menu atop the page to switch between sections. Should you have any inquiries or feedback about the dashboard, please feel free to reach out to us at support@envisionrisk.com.

Row {data-height=50}
-------------------------------------

### Date

```{r}
flexdashboard::valueBox(format(as.Date(params$workflow_object$Input$date), format="%B %d %Y"), "Date (of prediction)", icon = "fas fa-calendar-check", color = get_color_classic_trustworthy()[1])
```

### Risk Measure

```{r}
flexdashboard::valueBox(ifelse(params$workflow_object$Input$risk_measure == "ES", "Expected Shortfall", "Value-at-Risk"), "Risk Measure", icon = "fas fa-eye", color = get_color_classic_trustworthy()[2])
```

### Base Currency

```{r}
flexdashboard::valueBox(params$workflow_object$Input$base_cur, "Base Currency", icon = "fas fa-money-bill", color = get_color_classic_trustworthy()[3])
```

Row {data-height=50}
-------------------------------------

### Horizon (in days)

```{r}
flexdashboard::valueBox(params$workflow_object$Input$horizon, "Horizon (in days)", icon = "fas fa-binoculars", color = get_color_classic_trustworthy()[4])
```

### Significance Level

```{r}
flexdashboard::valueBox(paste(round(100*params$workflow_object$Input$signif_level, 1), "%", sep=""), "Significance Level", icon = "fas fa-crosshairs", color = get_color_classic_trustworthy()[5])
```

### Volatility Assumption

```{r}
flexdashboard::valueBox(params$workflow_object$Input$volatility_id, "Volatility Assumption (for the prediction)", icon = "fas fa-cogs", color = get_color_classic_trustworthy()[1])
```

Row {data-height=50}
-------------------------------------

The portfolio's uncertainty is best encapsulated by its profit/loss (P&L) distribution. The displayed P&L distribution is derived from simulating each individual position's P&L and aggregating them into potential future portfolio P&L scenarios. Each position's P&L distribution relies on EnvisionRiskâ€™s Economic Scenario Generator, which forecasts future market conditions per position. This generator employs advanced statistical methods utilizing extreme value distributions and copulas to more accurately capture financial instruments' unique characteristics. It's based on a Monte Carlo simulation approach, comprising 10,000 scenarios per position, acknowledging volatility clustering, skewed return distributions, and fat-tails. Such techniques excel at adapting to the stylized characteristics of financial returns.


Row {data-height=750}
-------------------------------------

### Portfolio Profit/Loss distribution

```{r}
risk_measurent <- sum(params$workflow_object[["portfolio_risk"]][["component"]])
suppressMessages(envrsk_plot_pnl(params$workflow_object[["portfolio_delta_vector"]], 
                                 risk_measurent, 
                                 params$workflow_object$Input$base_cur))
```   

Risk Decomposition {data-orientation=rows, data-navmenu="Navigate"}
=====================================     

Row {data-height=50}
-------------------------------------
The table below presents the market value, risk, and diversification impacts for the portfolio's top 10 positions, gauged by market value and risk, with all absolute figures displayed in the base currency. The 'regular' or 'unconditional' risk column reveals each position's marginal risk, while the 'component' or 'conditional' column demonstrates how each position contributes to the portfolio's overall risk. The diversification effect for a position is interpreted by the difference between the regular and component risk measures. The regular risk is always negative, while the component risk can be positive for individual positions. It's crucial to note that interpreting the component risk measure for positions with smaller weights can be challenging. For such positions, the component risk measure tends to represent noise more than signal.


Row {data-height=300}
-------------------------------------

### Positions, Market Value, Risk & Diversification

```{r}
dt_risk <- merge(params$workflow_object[["portfolio_risk"]], 
                 params$workflow_object[["positions"]], 
                 by = "uid", 
                 all.x = TRUE)
data.table::setnames(dt_risk, "amount", "quantity")
```

```{r}
dt_summary_risk <- dt_risk[, .(uid, symbol, name, quantity, notational, market_value, regular, component)]
suppressMessages(envrsk_summary_risk(dt_summary_risk,
                                     params$workflow_object$Input$base_cur))
```

Row {data-height=50}
-------------------------------------

The table on the left below illustrates the notional exposure and component-risk by currency. The area for each currency represents its notional exposure (as a percentage), while the color displays its associated risk level. The figure to the right highlights the top 10 riskiest positions, along with their respective risk diversification aspects. This dual-presentation provides an overview of exposure and risk, enabling informed decision-making.

Row {data-height=550}
-------------------------------------

### Portfolio Currency Denominated Risk

```{r}
dt_cur_risk <- dt_risk[, .(qc, notational, component)]
suppressMessages(envrsk_plot_currency_denominated_risk(dt_cur_risk, params$workflow_object$Input$base_cur))
```   

### Diversification Effects (top 10)

```{r}
dt_summary_risk <- dt_risk[, .(uid, symbol, name, quantity, notational, market_value, regular, component)]
suppressMessages(envrsk_plot_port_asset_diversification(dt_summary_risk,
                 params$workflow_object$Input$base_cur))
```
